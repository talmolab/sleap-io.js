name: Docs - PR Preview

on:
  pull_request:
    types: [opened, reopened, synchronize, closed]
    paths:
      - "docs/**"
      - "mkdocs.yml"
      - "hooks/**"
      - "src/**"
      - "demo/**"
      - "package.json"
      - "package-lock.json"
      - ".github/workflows/pr-preview.yml"

concurrency:
  group: pr-preview-${{ github.event.number }}
  cancel-in-progress: true

permissions:
  contents: write
  pull-requests: write

jobs:
  deploy:
    if: github.event.action != 'closed'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: npm
      - name: Install JS dependencies
        run: npm ci
      - name: Build package
        run: npm run build
      - name: Copy dist into docs assets
        run: |
          mkdir -p docs/assets/dist
          cp -R dist/* docs/assets/dist/
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - name: Install docs dependencies
        run: pip install -r docs/requirements.txt
      - name: Build docs
        run: mkdocs build --site-dir _site
      - name: Deploy PR Preview
        uses: JamesIves/github-pages-deploy-action@v4
        with:
          branch: gh-pages
          folder: _site
          target-folder: pr/${{ github.event.number }}
          commit-message: "Deploy PR #${{ github.event.number }} preview"
      - name: Comment on PR
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          header: docs-preview
          message: |
            ## Docs Preview
            - Preview URL: https://talmolab.github.io/sleap-io.js/pr/${{ github.event.number }}/
            - Commit: `${{ github.event.pull_request.head.sha }}`

  cleanup:
    if: github.event.action == 'closed'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          ref: gh-pages
      - name: Remove PR preview
        run: |
          if [ -d "pr/${{ github.event.number }}" ]; then
            rm -rf "pr/${{ github.event.number }}"
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"
            git add -A
            git commit -m "Remove PR #${{ github.event.number }} preview" || echo "Nothing to commit"
            git push
          fi
      - name: Comment on PR (cleanup)
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          header: docs-preview
          message: |
            ## Docs Preview
            Preview has been removed.
